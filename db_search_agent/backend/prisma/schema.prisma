generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String     @unique @db.VarChar(100)
  slug        String     @unique @db.VarChar(100)
  description String?
  parentId    Int?       @map("parent_id")
  createdAt   DateTime?  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime?  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children    Category[] @relation("CategoryToCategory")
  products    Product[]

  @@map("categories")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Product {
  id               Int                  @id @default(autoincrement())
  name             String               @db.VarChar(255)
  slug             String               @unique @db.VarChar(255)
  description      String?
  shortDescription String?              @map("short_description")
  sku              String?              @unique @db.VarChar(100)
  price            Decimal              @db.Decimal(10, 2)
  compareAtPrice   Decimal?             @map("compare_at_price") @db.Decimal(10, 2)
  costPrice        Decimal?             @map("cost_price") @db.Decimal(10, 2)
  categoryId       Int?                 @map("category_id")
  brand            String?              @db.VarChar(100)
  status           String?              @default("active") @db.VarChar(20)
  featured         Boolean?             @default(false)
  createdAt        DateTime?            @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime?            @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  images           ProductImage[]
  reviews          ProductReview[]
  tags             ProductTagRelation[]
  variants         ProductVariant[]
  category         Category?            @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([brand], map: "idx_products_brand")
  @@index([categoryId], map: "idx_products_category")
  @@index([featured], map: "idx_products_featured")
  @@index([price], map: "idx_products_price")
  @@index([sku], map: "idx_products_sku")
  @@index([status], map: "idx_products_status")
  @@map("products")
}

model ProductVariant {
  id             Int                @id @default(autoincrement())
  productId      Int                @map("product_id")
  name           String             @db.VarChar(100)
  sku            String?            @unique @db.VarChar(100)
  price          Decimal?           @db.Decimal(10, 2)
  compareAtPrice Decimal?           @map("compare_at_price") @db.Decimal(10, 2)
  stockQuantity  Int?               @default(0) @map("stock_quantity")
  trackInventory Boolean?           @default(true) @map("track_inventory")
  weight         Decimal?           @db.Decimal(8, 2)
  dimensions     Json?
  createdAt      DateTime?          @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime?          @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  images         ProductImage[]
  product        Product            @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  attributes     VariantAttribute[]

  @@index([productId], map: "idx_product_variants_product_id")
  @@index([stockQuantity], map: "idx_product_variants_stock")
  @@map("product_variants")
}

model VariantAttribute {
  id             Int            @id @default(autoincrement())
  variantId      Int            @map("variant_id")
  attributeName  String         @map("attribute_name") @db.VarChar(50)
  attributeValue String         @map("attribute_value") @db.VarChar(100)
  createdAt      DateTime?      @default(now()) @map("created_at") @db.Timestamp(6)
  variant        ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([attributeName, attributeValue], map: "idx_variant_attributes")
  @@map("variant_attributes")
}

model ProductImage {
  id        Int             @id @default(autoincrement())
  productId Int             @map("product_id")
  variantId Int?            @map("variant_id")
  url       String          @db.VarChar(500)
  altText   String?         @map("alt_text") @db.VarChar(255)
  sortOrder Int?            @default(0) @map("sort_order")
  isPrimary Boolean?        @default(false) @map("is_primary")
  createdAt DateTime?       @default(now()) @map("created_at") @db.Timestamp(6)
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([productId], map: "idx_product_images_product_id")
  @@map("product_images")
}

model ProductTag {
  id        Int                  @id @default(autoincrement())
  name      String               @unique @db.VarChar(50)
  slug      String               @unique @db.VarChar(50)
  createdAt DateTime?            @default(now()) @map("created_at") @db.Timestamp(6)
  products  ProductTagRelation[]

  @@index([name], map: "idx_product_tags_name")
  @@map("product_tags")
}

model ProductTagRelation {
  productId Int        @map("product_id")
  tagId     Int        @map("tag_id")
  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tag       ProductTag @relation(fields: [tagId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([productId, tagId])
  @@map("product_tag_relations")
}

model ProductReview {
  id               Int       @id @default(autoincrement())
  productId        Int       @map("product_id")
  userId           Int?      @map("user_id")
  rating           Int?
  title            String?   @db.VarChar(255)
  reviewText       String?   @map("review_text")
  verifiedPurchase Boolean?  @default(false) @map("verified_purchase")
  helpfulCount     Int?      @default(0) @map("helpful_count")
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  product          Product   @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([productId], map: "idx_product_reviews_product_id")
  @@map("product_reviews")
}
